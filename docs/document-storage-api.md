# Auction Document Storage API

This document describes the contract for uploading, persisting, and downloading
authorised auction documents stored in the `auctions-documents` bucket.

## Bucket

* **Provider:** Google Cloud Storage (via Firebase Admin SDK)
* **Bucket:** `AUCTIONS_DOCUMENTS_BUCKET` environment variable (defaults to
  `<project-id>-auctions-documents`)
* **Security:**
  * Forest owners can upload and delete their own documents.
  * Buyers receive time-limited, signed download URLs generated by the backend.
  * Storage rules enforce that only the owning forest account may upload or
    delete objects, while read access is scoped to authenticated users once an
    auction is public.

## Upload Flow

1. **Request upload session** – owner requests a signed upload URL.
2. **PUT to storage** – client uploads the file directly to the signed URL.
3. **Confirm metadata** – client notifies the API so metadata is persisted and
   (optionally) attached to an auction.

### `POST /api/documents/upload-url`

Request body:

```json
{
  "fileName": "permit.pdf",
  "mimeType": "application/pdf",
  "size": 204800,
  "auctionId": "optional-auction-id",
  "apvDocumentId": "optional-permit-number"
}
```

Response body:

```json
{
  "documentId": "uuid",
  "uploadUrl": "https://storage.googleapis.com/...",
  "storagePath": "auctions/<auctionId>/...",
  "requiredHeaders": { "Content-Type": "application/pdf" },
  "expiresAt": 1731622800000
}
```

Only authenticated forest owners can call this endpoint.

### `POST /api/documents`

Request body:

```json
{
  "documentId": "uuid-from-upload",
  "auctionId": "optional-auction-id",
  "name": "permit.pdf",
  "mimeType": "application/pdf",
  "size": 204800,
  "storagePath": "auctions/<auctionId>/...",
  "apvDocumentId": "optional-permit-number",
  "replaceExistingApv": true
}
```

Response body:

```json
{
  "metadata": {
    "id": "uuid",
    "name": "permit.pdf",
    "mimeType": "application/pdf",
    "size": 204800,
    "storagePath": "auctions/<auctionId>/...",
    "downloadUrl": "https://storage.googleapis.com/...",
    "apvDocumentId": "APV-123"
  }
}
```

When `auctionId` is supplied the metadata is attached to that auction and, if
`replaceExistingApv` is true, any previous APV file is removed from storage.

## Download Flow

### `GET /api/auctions/:auctionId/documents/:documentId/download`

Returns a fresh signed download URL valid for 15 minutes. Accessible to the
owning forest account and authenticated buyers once the auction is no longer a
`draft`.

Response body:

```json
{
  "downloadUrl": "https://storage.googleapis.com/...",
  "expiresAt": 1731622800000
}
```

## Metadata Persistence

* Metadata is stored in the Firestore `auctionDocuments` collection and inside
  each auction document as an array of
  `DocumentMetadata { id, name, mimeType, size, storagePath, downloadUrl, apvDocumentId? }`.
* Upload confirmations without an `auctionId` remain in the owner’s pending area
  until the auction is created. When `/api/auctions` is called, the provided
  metadata is attached to the newly-created auction and pending records are
  updated accordingly.

## Integration Tests

The Vitest suite exercises the following:

* Upload session negotiation (`/api/documents/upload-url`).
* Metadata persistence and Firestore attachment (`/api/documents`).
* Time-limited download URL refresh (`/api/auctions/:id/documents/:docId/download`).
